<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="jMuxer - a simple javascript mp4 muxer for non-standard streaming communications protocol">
    <meta name="keywords" content="h264 player, mp4 player, mse, mp4 muxing, jmuxer, aac player">
    <title>JMuxer demo</title>
</head>
<body>
<p><b>Prerequisite command:</b> `node h264.js`</p>
<div id="container" style="margin: 0 auto; text-align: center;">
    <video style="border: 1px solid #333; max-width: 500px;" controls autoplay id="player"></video>
</div>

<input id="range1" type="range" min="-50" max="50" value="0" step="0.1" onchange="change1()">
<span id="value1">0</span>

<input id="range2" type="range" min="-50" max="50" value="0" step="0.1" onchange="change2()">
<span id="value2">0</span>

<input id="range3" type="range" min="-50" max="50" value="0" step="0.1" onchange="change3()">
<span id="value3">0</span>

<input id="rotationX" type="range" min="0" max="360" value="0" step="0.1" onchange="rotationX()">
<span id="x">0</span>

<input id="rotationY" type="range" min="0" max="360" value="70" step="0.1" onchange="rotationY()">
<span id="y">0</span>

<input id="rotationZ" type="range" min="0" max="360" value="0" step="0.1" onchange="rotationZ()">
<span id="z">0</span>


<input id="fovx" type="range" min="0" max="360" value="60" step="0.1" onchange="fov()">
<span id="xfov">60</span>

<input id="fovy" type="range" min="0" max="360" value="60" step="0.1" onchange="fov()">
<span id="yfov">60</span>

<input id="ip" type="text">
<button onclick="Mstart()">连接</button>
<script>
var jmuxer;
var ws;
var buffer;

var Msg;
var Calibration;

function Mstart() {
    var value = document.getElementById('ip').value ;
    initWs(value)
}

window.onload = function() {

    var protobuf = require("protobufjs");
    protobuf.load("./msg.proto", function (err, root) {
    if (err)
        throw err;

    // Obtain a message type
    Msg = root.lookupType("Msg");

    // Exemplary payload
    var payload = { type: 4};

    // Verify the payload if necessary (i.e. when possibly incomplete or invalid)
    var errMsg = Msg.verify(payload);
    if (errMsg)
        throw Error(errMsg);

    // Create a new message
    var message = Msg.create(payload); // or use .fromObject if conversion is necessary

    // Encode a message to an Uint8Array (browser) or Buffer (node)
    buffer = Msg.encode(message).finish();
    // ... do something with buffer

    });

    jmuxer = new JMuxer({
        node: 'player',
        mode: 'video',
        flushingTime: 10,
        fps: 60,
        debug: false,
        onError: function(data) {
            if (/Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor)) {
                jmuxer.reset();
            }
        }
     });

 }

function initWs(ip) {
    console.log('initWs ' + ip);
    ws = new WebSocket("ws://" + ip + ":12388");
    //  var ws = new WebSocket(socketURL);
     ws.binaryType = 'arraybuffer';
     ws.addEventListener('message',function(event) {
        var vDara = new Uint8Array(event.data)
        // console.log(vDara)
        // Decode an Uint8Array (browser) or Buffer (node) to a message
        var message = Msg.decode(vDara);
        // console.log(message)
        switch (message.type) {
            case 0:
                console.log(message.controlHandleCoordinate)
                break;
        
            default:
                // ... do something with message
                        if(vDara.byteLength == 0){

                }else{
                    jmuxer.feed({
                        video: message.videoStream
                    });
                }
                break;
        }
        
        
     });

     ws.addEventListener('error', function(e) {
        console.log('Socket Error');
     });

    // 接続が開いたときのイベント
    ws.addEventListener('open', function (event) {
        ws.send(buffer);
    });
 }

function change1() {
    var value = document.getElementById('range1').value ;
    document.getElementById('value1').innerHTML = value;
    sendXYZ();
}

function change2() {
    var value = document.getElementById('range2').value ;
    document.getElementById('value2').innerHTML = value;
    sendXYZ();
}

function change3() {
    var value = document.getElementById('range3').value ;
    document.getElementById('value3').innerHTML = value;
    sendXYZ();
}


function rotationX() {
    var value = document.getElementById('rotationX').value ;
    document.getElementById('x').innerHTML = value;
    sendXYZ();
}

function rotationY() {
    var value = document.getElementById('rotationY').value ;
    document.getElementById('y').innerHTML = value;
    sendXYZ();
}

function rotationZ() {
    var value = document.getElementById('rotationZ').value ;
    document.getElementById('z').innerHTML = value;
    sendXYZ();
}


function sendXYZ() {
    var x = document.getElementById('range1').value ;
    var y = document.getElementById('range2').value ;
    var z = document.getElementById('range3').value ;

    var rotationX = document.getElementById('rotationX').value ;
    var rotationY = document.getElementById('rotationY').value ;
    var rotationZ = document.getElementById('rotationZ').value ;

    var mPhonePosture  = {
        posX: parseFloat(x), posY: parseFloat(y), posZ: parseFloat(z),
        pitchAngle : parseFloat(rotationX),
        yawAngle   : parseFloat(rotationY),
        rollAngle  : parseFloat(rotationZ),
    }

    var payload = { PhonePosture: mPhonePosture, type: 2};
    console.log(payload)

    var errMsg = Msg.verify(payload);
    if (errMsg)
        throw Error(errMsg);
    var message = Msg.create(payload); // or use .fromObject if conversion is necessary
    buffer = Msg.encode(message).finish();

    ws.send(buffer);
}


function fov() {
    var value = document.getElementById('fovx').value ;
    document.getElementById('xfov').innerHTML = value;

    value = document.getElementById('fovy').value ;
    document.getElementById('yfov').innerHTML = value;

    sendCalibration();
}

function sendCalibration() {
    var xFov = document.getElementById('fovx').value ;
    var yFov = document.getElementById('fovy').value ;

    var payload = { CalibrationParams:  {
        xFov  : xFov,
        yFov  : yFov,
    }, type: 1};

    console.log(payload)

    var errMsg = Msg.verify(payload);
    if (errMsg)
        throw Error(errMsg);
    var message = Msg.create(payload); // or use .fromObject if conversion is necessary
    buffer = Msg.encode(message).finish();

    ws.send(buffer);
}


</script>
<script type="text/javascript" src="jmuxer.min.js"></script>
</body>
</html>
